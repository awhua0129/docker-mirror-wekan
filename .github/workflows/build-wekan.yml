name: Build and Export Wekan Docker Image

on:
  # 手动触发
  workflow_dispatch:
  # 或定时触发（可选）
  schedule:
    - cron: '0 2 * * 0'  # 每周日凌晨2点

env:
  IMAGE_NAME: wekan/wekan
  IMAGE_TAG: latest

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub (Optional)
      if: false  # 禁用，因为可能无法登录
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build or Pull Wekan Image
      run: |
        # 尝试从多个源拉取镜像
        echo "尝试从多个源拉取镜像..."
        
        # 尝试官方源
        if docker pull $IMAGE_NAME:$IMAGE_TAG; then
          echo "✓ 成功从官方源拉取"
        else
          echo "✗ 官方源失败，尝试GitHub Container Registry"
          if docker pull ghcr.io/wekan/wekan:$IMAGE_TAG; then
            docker tag ghcr.io/wekan/wekan:$IMAGE_TAG $IMAGE_NAME:$IMAGE_TAG
            echo "✓ 成功从GHCR拉取"
          else
            echo "✗ 所有源都失败，从源码构建"
            # 克隆Wekan源码
            git clone https://github.com/wekan/wekan.git
            cd wekan
            docker build -t $IMAGE_NAME:$IMAGE_TAG .
          fi
        fi
        
    - name: Save Docker Image
      run: |
        # 保存镜像为tar文件
        echo "正在保存镜像..."
        docker save $IMAGE_NAME:$IMAGE_TAG -o wekan.tar
        
        # 计算文件大小
        echo "镜像大小:"
        ls -lh wekan.tar
        
        # 压缩（可选）
        echo "正在压缩..."
        gzip -9 wekan.tar
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: wekan-docker-image
        path: wekan.tar.gz
        retention-days: 7
        compression-level: 0  # 不压缩，因为已经压缩过了
        
    - name: Upload to Release (可选)
      if: github.event_name == 'workflow_dispatch'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 创建版本发布
        gh release create v$(date +%Y%m%d) \
          --title "Wekan Docker Image $(date +%Y-%m-%d)" \
          --notes "Automatically built Wekan Docker image" \
          wekan.tar.gz
