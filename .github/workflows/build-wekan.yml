name: Build and Export Wekan Docker Image

on:
  workflow_dispatch:

# 添加权限配置
permissions:
  contents: write  # 允许创建 Release

env:
  IMAGE_NAME: wekan/wekan
  IMAGE_TAG: latest

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    
    # 或者在 job 级别设置权限
    permissions:
      contents: write  # 允许写入内容（创建 Release）
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Pull Wekan Image
      run: |
        docker pull dockerproxy.com/wekan/wekan:latest
        docker tag dockerproxy.com/wekan/wekan:latest wekan/wekan:latest
        
    - name: Save Docker Image
      run: |
        docker save wekan/wekan:latest | gzip > wekan.tar.gz
        ls -lh wekan.tar.gz
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v$(date +%Y%m%d)
        name: "Wekan Docker Image $(date +%Y-%m-%d)"
        body: "Automatically built Wekan Docker image"
        files: wekan.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
