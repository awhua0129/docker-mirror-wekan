name: Wekan Docker Mirror

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'  # 每周更新

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Docker
      run: |
        # 配置镜像源
        sudo mkdir -p /etc/docker
        echo '{"registry-mirrors": ["https://dockerproxy.com"]}' | sudo tee /etc/docker/daemon.json
        sudo systemctl restart docker
        
    - name: Pull Wekan Image
      run: |
        # 尝试多个源
        SOURCES=(
          "dockerproxy.com/wekan/wekan:latest"
          "ghcr.io/wekan/wekan:latest" 
          "quay.io/wekan/wekan:latest"
        )
        
        for source in "${SOURCES[@]}"; do
          echo "尝试从 $source 拉取..."
          if docker pull "$source"; then
            docker tag "$source" wekan/wekan:latest
            echo "✓ 成功从 $source 拉取"
            break
          else
            echo "✗ $source 失败"
          fi
        done
        
    - name: Verify Image
      run: |
        docker images | grep wekan
        docker inspect wekan/wekan:latest | grep -i version
        
    - name: Save Image
      run: |
        docker save wekan/wekan:latest | gzip > wekan-$(date +%Y%m%d).tar.gz
        echo "文件信息:"
        ls -lh wekan-*.tar.gz
        
    - name: Upload to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wekan-docker-image
        path: wekan-*.tar.gz
        retention-days: 90
        
    - name: Create GitHub Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: wekan-*.tar.gz
        tag_name: wekan-$(date +%Y%m%d)
        name: "Wekan Docker Image $(date +%Y-%m-%d)"
        body: |
          自动构建的 Wekan Docker 镜像
          
          - 构建时间: $(date)
          - 镜像版本: latest
          - 文件大小: $(ls -lh wekan-*.tar.gz | awk '{print $5}')
          
          使用方法:
